var t;

$(document).ready(function () {
    loadTable(reqTableUrl, authToken);
    $('#tblAssignPurchaser').on('page.dt', function () {
        retrieveEmployee(reqUserList);
    });

    $("#btnSubmitPurchaser").click(function () {
        Drawer_Show("#AssignConfirmModal");
    });

    $('#checkAll').on('click',function(){
        $('.checkbox').prop('checked', this.checked);
    });

    $('#btnResetField').on('click', function () {
        $('.checkbox').prop('checked', false);
        retrieveEmployee(reqUserList);
    });

    $('#btnConfirmAssign').click(function (e) {
        var datap = t.$('input, select').serializeArray();
        $.each($(datap), function (index, element) {
            var purchasers = [];
            $("." + datap[index].value).val(function (index, value) {
                purchasers.push({
                    value
                });
            });
            datap[index].purchaser = purchasers;
        });

        submitPurchaser(datap);
        
        return false;
    });

    $("#AssignmentForm, #tblAssignPurchaser").submit(function (e) {
        e.preventDefault();
        var values = {};
        $.each($('#AssignmentForm').serializeArray(), function (i, field) {
            values[field.name] = field.value;
        });

        var $inputs = $('#AssignmentForm :input');
        var values = {};
        $inputs.each(function () {
            values[this.name] = $(this).val();
        });
    });

    $("#btnCloseModal").click(function () {
        Drawer_Hide("#AssignConfirmModal");
    });
});

function retrieveEmployee(reqUserList) {
    $.ajax({
        url: reqUserList,
        type: 'POST',
        headers: {
            "Content-Type": "application/json; charset=utf-8",
            "Authorization": "Bearer " + authToken
        },
        success: function (data, status, xhr) {
            $("select").empty();
            var $option = $("<option></option>", {
                "name": "select",
                "text": "select..",
                "value": null
            });
            $("select").append($option);

            for (var i = 0; i < data.data.length; i++) {
                var $option = $("<option></option>", {
                    "name": data.data[i].Name,
                    "text": data.data[i].Name,
                    "value": data.data[i].AccessId
                });
                $("select").append($option);
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
        }
    });
}

function retrieveAssignedPurchaser() {
    $.ajax({
        url: reqAssignedPurchaser,
        type: 'GET',
        headers: {
            "Content-Type": "application/json; charset=utf-8",
            "Authorization": "Bearer " + authToken
        },
        success: function (data, status, xhr) {
            for (var i = 0; i < data.data.length; i++) { //4 data
                try{
                    var selects = $("." + data.data[i].RFQNo);
                    var elem1Index;
                    var elem2Index;
                    for (var x = 0; x < selects[0].options.length; x++) {//loop options
                        if (selects[0].options[x].value === data.data[i].Purchaser1) {
                            elem1Index = x
                            selects[0].options[x].setAttribute("selected", "selected");
                        }
                        if (selects[1].options[x].value === data.data[i].Purchaser2) {
                            elem2Index = x
                            selects[1].options[x].setAttribute("selected", "selected");
                        }
                    }
                }
                catch(ex){}
               
               
                var $option2 = $("<option></option>", {
                    "name": data.data[i].Purchaser2StaffName,
                    "text": data.data[i].Purchaser2StaffName,
                    "value": data.data[i].Purchaser2
                });
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {

        }
    });
}

function loadTable(reqTableUrl, authToken) {
    var numbers = { "": ""}
    t = $('#tblAssignPurchaser').DataTable(
        {
            "processing": true,
            "serverSide": false,
            "stateSave": true,
            "ajax":
            {
                "url": reqTableUrl,
                "contentType": "application/json",
                "type": "GET",
                "dataType": "JSON",
                "beforeSend": function (xhr) {
                    xhr.setRequestHeader("Authorization",
                        "Bearer " + authToken);
                },
                "data": function (d) {
                    return d;
                }
            },
            "columnDefs": [{
                "targets": 0,
                "orderable": false
            }],
            "columns": [
                {

                    "data": "RFQNo",
                    "mRender": function(data, type, full){
                        var constructStr = '<input class="checkbox" name="RFQNo" type ="checkbox" value="' + data + '"/>'
                        return constructStr;
                    },
                    "width": "2%"
                },
                {

                    "data": "RFQNo",
                    "width": "10%"
                },
                {
                    "data": "Title",
                    "width": "10%"
                },
                {
                    "data": "Description",
                    "width": "30%"
                },
                {
                    "data": "RFQ_StatusID",
                    "mRender": function (data, type, full) {
                        if (data == 1)
                            return "Submitted";
                        else
                            return "Not Submitted";
                    },
                    "width": "5%"
                },
                {
                    "data": "CreatedByStaffName",
                    "width": "10%"
                },
                {
                    "data": "CreatedDate",
                    "width": "10%"
                },
                {
                    "data": "RFQNo",
                    "mRender": function (data, type, full) {
                        var constructStr = '<select class="' + data + '"><option name="select" value=null>select..</option></select>'
                        return constructStr;
                    },
                    "width": "10%"
                },
                {
                    "data": "RFQNo",
                    "mRender": function (data, type, full) {
                        var constructStr = '<select class="'+ data +'"></select>'
                        return constructStr;
                    },
                    "width": "10%"
                }
            ],
            "initComplete": function (settings, json) {
                $('[data-toggle="tooltip"]').tooltip();
                retrieveEmployee(reqUserList);
            },
            "searchable": true,
            "orderable": true,
            "responsive": {
                "details": false
            },
            "order": [[1, 'asc']],
            "autoWidth": true,
        });

    $('.form-control input-sm').attr('style', 'width:auto;');
}
//data table end

function submitPurchaser(data) {
    dataStr = {
        submitList: data
    };

    $.ajax({
        url: reqSubmitPurchaserUrl,
        type: "POST",
        data: JSON.stringify(dataStr),
        dataType: "json",
        headers: {
            "Content-Type": "application/json; charset=utf-8",
            "Authorization": "Bearer "+ authToken
        },
        success: function (data, status, xhr) {
            alert("success");
        },
        error: function (xhr, ajaxOptions, thrownError) {
            if (xhr.responseJSON["Message"])
                alert('Failed to submit data.\nReason : ' + xhr.responseJSON["Message"]);
            else
                alert('Purchaser 1 is required.');
        }


    })
    }
    