var t;
var canceledFiles = [];
var counter = 0;

$(document).ready(function () {
    uploadImage();
    retrieveWatcherEmail();
    var modalMode = 0;
    $("#ulBasicInfo").empty();
    $("#ulAttachments").empty();
    retrieveAttachment();
    retrieveData();
    loadTable();
    
    if ($("#hdnRFQID").val()) {
        setMode(1);
    }
    $("#RFQForm").submit(function (e) {
        e.preventDefault();
    });

    $("#btnResetField").click(function () {
        resetField();
    })

    $("#btnConfirmEdit").click(function () {
        editRFQWithUpload(canceledFiles);
    })

    $("#addWatcherIcon").click(function () {
        Drawer_Show($("#watcherModal"), false);
    })

    $("#btnAddWatcher").click(function () {
        console.log("test");
        addWatcher();
    })
});

function setMode(mode) {
    modalMode = mode;
}

function loadTable() {
    var data = {
        ID: $("#hdnRFQID").val()
    }

    t = $("#tblRFQUpdateHistory").DataTable(
        {
            "processing": true,
            "serverSide": false,
            "stateSave": true,
            "ajax":
            {
                "url": reqTableUrl,
                "contentType": "application/json",
                "type": "POST",
                "dataType": "JSON",
                "beforeSend": function (xhr) {
                    xhr.setRequestHeader(
                        "Authorization","Bearer " + authToken);
                },
                "data": function (d) {
                    d.ID = $("#hdnRFQID").val();
                    return JSON.stringify(d);
                },
                //"dataSrc": function (json) {
                //    console.log("dataSrc", json);
                //    if (!json)
                //        return [];
                //    return json.data;
                //},
                //"dataSrc": ''
            },
            "columns": [
                {
                    "data": "CreatedDate",
                    "width": "10%"
                },
                {
                    "data": "CreatedByStaffName",
                    "width": "10%",
                },
                {
                    "data": "Description",
                    "width": "30%"
                },
                {
                    "data": "UpdateRemark",
                    "width": "30%"
                }
            ],
            "searchable": true,
            "orderable": true,
            "responsive": {
                "details": false
            },
            "order": [[1, 'asc']],
            "autoWidth": true,
        });
}

function retrieveData() {
    var datastr = {
        ID: $("#hdnRFQID").val(),
    };
    $.ajax({
        url: reqDataUrl,
        type: "POST",
        data: JSON.stringify(datastr),
        dataType: "JSON",
        headers: {
            "Content-Type": "application/json; charset=utf-8",
            "Authorization": "Bearer " + authToken
        },
        success: function (data) {
            var status = "completed"
            if (data.RFQ_StatusID == 0) 
                status = "on going";
            $("#txtRaisedBy").text('Raised by ' + data.CreatedByStaffName + ' - on ' + data.CreatedDate);
            $("#txtDescription").text(data.Description);
            $("#txtRemark").text(data.Description);
            $("#txtTitle").val(data.Title);
            $("#txtRFQNo").text(data.RFQNo);
            $("#ulBasicInfo").append('<li style="border-top:solid 1px #BEBEBE; color:#8A8A8A; font-weight: 400; font-size: 16px; padding: 10px 15px 10px 15px;">Status <span style="float:right; color:#333333">' + status + '</span></li>');
            $("#ulBasicInfo").append('<li style="border-top:solid 1px #BEBEBE; color:#8A8A8A; font-weight: 400; font-size: 16px; padding: 10px 15px 10px 15px;">RFQNo. <span style="float:right; color:#333333">' + data.RFQNo + '</span></li>');
            $("#ulBasicInfo").append('<li style="border-top:solid 1px #BEBEBE; color:#8A8A8A; font-weight: 400; font-size: 16px; padding: 10px 15px 10px 15px;">Purchaser1 <span style="float:right; color:#333333">' + data.Purchaser1StaffName + '</span></li>');
            $("#ulBasicInfo").append('<li style="border-top:solid 1px #BEBEBE; color:#8A8A8A; font-weight: 400; font-size: 16px; padding: 10px 15px 10px 15px;">Purchaser2 <span style="float:right; color:#333333">' + data.Purchaser2StaffName + '</span></li>');
            $("#ulBasicInfo").append('<li style="border-top:solid 1px #BEBEBE; color:#8A8A8A; font-weight: 400; font-size: 16px; padding: 10px 15px 10px 15px;">Created Date <span style="float:right; color:#333333">' + data.CreatedDate + '</span></li>');
            $("#ulBasicInfo").append('<li style="border-top:solid 1px #BEBEBE; color:#8A8A8A; font-weight: 400; font-size: 16px; padding: 10px 15px 10px 15px;">Last Updated Date <span style="float:right; color:#333333">' + data.LastUpdatedDate + '</span></li>');
        },
        error: function (xhr, ajaxOptions, thrownError) {
        }
    });
}

function retrieveWatcherEmail() {
    var datastr = {
        ID: $("#hdnRFQID").val(),
    };
    $.ajax({
        url: reqWatcherEmailUrl,
        type: "POST",
        data: JSON.stringify(datastr),
        dataType: "JSON",
        headers: {
            "Content-Type": "application/json; charset=utf-8",
            "Authorization": "Bearer " + authToken
        },
        success: function (data) {
            for (var i in data) {
                console.log(i);
                $("#ulWatcherList").append('<li>' + data[i].EmailAddress + '</li>');
            }
        }
    });
}


function editRFQWithUpload(canceledFiles) {
    var datastr = {
        ID: $("#hdnRFQID").val(),
        Title: $("#txtTitle").val(),
        Description: $("#txtRemark").val(),
        CanceledFilesList: canceledFiles,
        TraceAction: 17
    };
    var fileBox = $(".fileBox .attachment2");
    var imageArr = [];
    var fileData = new FormData();
    var _checkFileType = true;

    fileData.append('JsonString', JSON.stringify(datastr));

    if ($('.fileBox')[0]) {
        var _countFile = 0;
        var _filesize = 0;
        var counter = 0;
        $.each($('.fileBox .attachment2'), function () {
            $.each($(fileBox[counter])[0].files, function (key, value) {
                var _randNo = Math.floor(Math.random() * 9000) + 1000;
                var _newFilename = _randNo + "-" + value.name;

                if (value.size > 2000000)
                    alert('file (' + value.name + ') exceed 2mb limit.');

                //_filesize = _filesize + value.size;
                fileData.append('file', value, _newFilename);
                _countFile++;
                counter++;
                var ext = _newFilename.split('.').pop().toLowerCase();
                if ($.inArray(ext, ['gif', 'jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx']) == -1) {
                    _checkFileType = false;
                    $("#btnSubmit").removeAttr('disabled', 'disabled');
                    return;
                }
            });
        })

        if (!_checkFileType) {
            alert('Invalid file type\nOnly allow file type .pdf/.doc/.docx/.png/.jpg/.jpeg');
            $("#btnSubmit").removeAttr('disabled', 'disabled');
            return;
        }
        //check file size
        //if (_fileSize > 2000000) {
        //    sweetAlertMessage('File uploaded exceed 2mb', 'error', false, "Please upload file size below 2mb");
        //    return;
        //}
    }

    $.ajax({
        headers: {
            "Authorization": "Bearer " + authToken
        },
        url: reqEditRFQWithUploadUrl,
        processData: false,
        contentType: false,
        data: fileData,
        type: 'POST'
    }).done(function (result) {
        //tblCal.api().ajax.reload(null, false);
        //tl.ajax.reload();
        if (result["Message"])
            alert(result["Message"]);
        else {
            alert("Data edited Successfully");
        }

    }).fail(function (xhr, ajaxOptions, thrownError) {
        if (xhr.responseJSON["Message"])
            alert('Failed to add data.\nReason : ' + xhr.responseJSON["Message"]);
        else
            alert('Failed to add data');
    });
};

function addWatcher() {
    var datastr = {
        ID: $("#hdnRFQID").val(),
        email: $("#txtWatcher").val()
    }
    $.ajax({
        url: reqAddNewWatcher,
        type: "POST",
        data: JSON.stringify(datastr),
        dataType: "JSON",
        headers: {
            "Content-Type": "application/json; charset=utf-8",
            "Authorization": "Bearer " + authToken
        },
        success: function (data) {
            alert("data added successfully");
        },
        error: function (xhr, ajaxOption, thrownError){
            alert("data added failed");
    }
    })
}

function uploadImage() {
    var button = $('.fileBox .addButton')
    //var uploader = $('<div class="fileContainer"><input class="attachment2" type="file" onchange="readURL(this);"/><div>')
    var fileBox = $('.fileBox')

    button.on('click', function () {
        fileBox.prepend('<div class="fileContainer"><input class="attachment2" type="file" onchange="readURL(this);"/></div>')
        //uploader.click()
    })

    fileBox.on('click', '.attachment', function () {
        $(this).remove()
    })
}

function minimizeAttachment(container, fileID) {
    $(container).remove();
    canceledFiles.push(fileID);
}

function readURL(input) {
    for (var i = 0; i < input.files.length; i++) {
        if (input.files && input.files[0]) {
            var returnStr = "";
            returnStr += '<div class="attachment-title-wrap" id="a' + counter + '">';
            returnStr += '<span class="fa-stack fa-2x">';
            returnStr += '<i class="fa-solid fa-file fa-stack-2x "></i><i class="fa-solid fa-circle-minus fa-2xs fa-stack" style="color:red; position:absolute;bottom:37px; right:-17px;" onclick="minimizeAttachment(this.parentNode.parentNode.parentNode)"></i>';
            returnStr += '</span>';
            returnStr += '<span class="attachment-title">' + input.files[i].name + '</span>';
            returnStr += '</div>';
            $(input.parentNode).append(returnStr);
            $(input).hide();
        }
        else {
            removeUpload();
        }
        counter = counter + 1;
    }
}

function retrieveAttachment() {
    var datastr = {iD: $("#hdnRFQID").val()};
    var returnStr = "";
    $.ajax({
        url: reqAttachmentUrl,
        type: "POST",
        data: JSON.stringify(datastr),
        dataType: "json",
        headers: {
            "Content-Type": "application/json; charset=utf-8",
            "Authorization": "Bearer " + authToken
        },
        success: function (data, status, xhr) {
            canceledFiles = [];
            $.each(data, function (key, value) {
                var attachmentNameArray = value.AttachmentName.split("_")
                $("#ulAttachments").append('<li class="d-flex flex-row border-top align-items-center justify-content-between" style="padding: 15px 15px 0px 15px;"><div class="d-flex flex-column text-right">' +
                                '<p style="color:#333333; font-weight: 400; font-size: 16px;">'+attachmentNameArray[2]+'</p>'+
                                '<p style="color:#8A8A8A; font-weight: 400; font-size: 14px;">' + value.CreatedByStaffName + ' | '+ value.CreatedDate +'</p></div><a href="#"><i class="fa-solid fa-download"></i></a></li>')

                var returnStr = "";
                returnStr += '<div class="fileContainer">';
                returnStr += '<div class="attachment-title-wrap" id="a' + counter + '">';
                returnStr += '<span class="fa-stack fa-2x">';
                returnStr += '<i class="fa-solid fa-file fa-stack-2x "></i><i class="fa-solid fa-circle-minus fa-2xs fa-stack" style="color:red; position:absolute;bottom:37px; right:-17px;" onclick="minimizeAttachment(this.parentNode.parentNode, ' + value.ID + ')"></i>';
                returnStr += '</span>';
                returnStr += '<span class="attachment-title">' + attachmentNameArray[2] + '</span>';
                returnStr += '</div>';
                returnStr += '</div>';
                $(".fileBox").prepend(returnStr);
            });
        },
        error: function (xhr, ajaxOptions, thrownError) {
            alert("data failed to load");
        }
    });
}

function resetField() {
    var resetForm = [$("#txtRemark")];

    $.each(resetForm, function (key, value) {
        value.val("");
        value.removeClass("error");
    });

    $("#selStatus").val("");
}