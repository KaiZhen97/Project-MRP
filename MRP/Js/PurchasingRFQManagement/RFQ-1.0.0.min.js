var authToken = "";
var reqTableURL = "";
var reqLoadStatusUrl = "";
var reqLoadModuleNameUrl = "";
var reqAddNewRFQUrl = "";
var reqEditRFQUrl = "";
var currentSelectedRFQ;
var currentSelectedDraft;
var RFQSetupTable = null;
var modalMode = 0;
var currModalMode = 'new';
var t;

$(document).ready(function () {
    loadTable(reqTableURL, authToken);

    $("#keywordSearch").on("keyup", function () {
        var value = $(this).val().toLowerCase();
        $("#ulDraftList li").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });

    $("#btnCancelYes").click(function () {
        deleteRFQ(); 
    });

    $("#btnDeleteDraftYes").click(function () {
        deleteRFQDraft();
    });

    $("#btnCancelNo").click(function () {
        Drawer_Hide($("#CancelRFQModal"));
    });

    $("#btnPurchasing").click(function () {
        changeToPurchasingList()
    });

    $("#btnLogistic").click(function () {
        changeToLogisticList()
    });

});


function loadTable(reqTableUrl, authToken) {
    t = $('#tblRFQData').DataTable(
        {
            "processing": true,
            "serverSide": false,
            "stateSave": true,
            "ajax":
            {
                "url": reqTableUrl,
                "contentType": "application/json",
                "type": "GET",
                "dataType": "JSON",
                "beforeSend": function (xhr) {
                    xhr.setRequestHeader("Authorization",
                        "Bearer " + authToken);
                },
                "data": function (d) {
                    return d;
                }
            },
            "columns": [
                {
                    "data": "RFQNo",
                    "width": "10%"
                },
                {
                    "data": "Title",
                    "width": "10%"
                },
                {
                    "data": "Description",
                    "width": "30%"
                },
                {
                    "data": "RFQ_StatusID",
                    "mRender": function (data, type, full) {
                        if (data == 1)
                            return "Submitted";
                        else
                            return "Not Submitted";
                    },
                    "width": "5%"
                },
                {
                    "data": "CreatedByStaffName",
                    "width": "10%"
                },
                {
                    "data": "Purchaser1",
                    "width": "10%"
                },
                {
                    "data": "CreatedDate",
                    "width": "10%"
                },
                {
                    "data": "LastUpdatedDate",
                    "width": "10%"
                }
            ],
            "initComplete": function (settings, json) {
                $('[data-toggle="tooltip"]').tooltip();
            },
            "searchable": true,
            "orderable": true,
            "responsive": {
                "details": false
            },
            "order": [[1, 'asc']],
            "autoWidth": true,
        });

    $('.form-control input-sm').attr('style', 'width:auto;');
}

function searchDraft() {
    var input, filter, ul, li, a, i, txtValue;
    input = document.getElementById("keywordSearch");
    filter = input.value.toUpperCase();
    ul = document.getElementById("ulDraftList");
    li = ul.getElementsByTagName("li");
    for (i = 0; i < li.length; i++) {
        a = li[i].getElementsByTagName("p")[0];
        txtValue = li.textContent || li.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
            li[i].style.display = "";
        } else {
            li[i].style.display = "none";
        }
    }
}

function setMode(mode) {
    modalMode = mode;
}

function setCurrentSelectedRFQ(RFQ) {
    currentSelectedRFQ = RFQ;
}

function setCurrentSelectedDraft(ID) {
    currentSelectedDraft = ID;
}

function retrieveData(id) {
    var dataStr = { ID: id };
    setMode(1);
    $.ajax({
        url: reqDataUrl,
        type: "POST",
        data: JSON.stringify(dataStr),
        dataType: "json",
        headers: {
            "Content-Type": "application/json; charset=utf-8",
            "Authorization": "Bearer " + authToken
        },
        success: function (data, status, xhr) {
            $("#txtRFQNo").val(data.RFQNo);
            $("#txtTitle").val(data.Title);
            $("#txtDescription").val(data.Description);

        },
        error: function (xhr, ajaxOptions, thrownError) {
            alert("data retrieve failed");
        }
    });
}

function deleteRFQ () {
    var dataStr = {
        ID: currentSelectedRFQ,
        CancelRemark: $("#txtRemarks").val()
    };
    $.ajax({
        url: reqDeleteUrl,
        type: 'Post',
        dataType: 'json',
        data: JSON.stringify(dataStr),
        headers: {
            "Content-Type": 'application/json; charset=utf-8',
            "Authorization": "Bearer " + authToken,
        },
        success: function (data, status, xhr) {
            alert("data successfully deleted");
            Drawer_Hide($("#CancelRFQModal"));
            t.ajax.reload();
        },
        error: function (xhr, ajaxOptions, thrownError) {
            alert("data delete failed")
            error(xhr);
        }
    })
};

function deleteRFQDraft() {
    var dataStr = {
        ID: currentSelectedDraft,
        CancelRemark: $("#txtRemarks").val()
    };
    $.ajax({
        url: reqDeleteDraftUrl,
        type: 'Post',
        dataType: 'json',
        data: JSON.stringify(dataStr),
        headers: {
            "Content-Type": 'application/json; charset=utf-8',
            "Authorization": "Bearer " + authToken,
        },
        success: function (data, status, xhr) {
            alert("data successfully deleted");
            Drawer_Hide($("#DeleteDraftModal"));
            Drawer_Hide($("#DraftModal"));
            t.ajax.reload();
        },
        error: function (xhr, ajaxOptions, thrownError) {
            alert("data delete failed")
            error(xhr);
        }
    })
};


$("#btnDraftItem").click(function () {
    $.ajax({
        url: reqDraftRFQUrl,
        contentType: 'application/json; charset=utf-8',
        type: 'GET',
        dataType: 'JSON',
        beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization",
                "Bearer " + authToken);
        },
        data: function (d) {
            return d;
        },

        success: function (data) {
            for (i in data.data) {
                $("#ulDraftList").append('<li><div class=" d-flex justify-content-between "><div class=" d-flex flex-column p-2 "><p style="margin-bottom:0px;font-weight:500; font-size:20px;">Raise: ' + data.data[i].RFQNo + '</p>'+
                    '<p class="mb-2" style="font-size:16px; font-weight:400">Request For Quotation</p><p style="font-size:14px; color: rgba(80, 80, 80, 0.5);">Created on ' + data.data[i].CreatedDate + '</p></div><div class=" d-flex flex-column justify-content-center p-2 "><a class="clickableLink" href="RaiseRFQ/' + data.data[i].ID +
                    '" style="color:#505050;" data-toggle="tooltip" data-placement="top" title="Edit"><i class="fa fa-edit"></i><a class="clickableLink" href="#"onclick="showDeleteDrawer('+data.data[i].ID+');"'+
                    '" style="color:#505050;" data-toggle="tooltip" data-placement="top" title="Delete"><i class="fa-solid fa-trash-can"></i>' +
                    '</div></div></li>');
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            error(xhr);
        }

    });
    $("#ulDraftList").empty();
    var b = "#DraftModal";

    Drawer_ResetInput(b);
    Drawer_Show(b);
})

function editDraft(value) {
    $("#hdnID").val(value);
    retrieveData(value);
}

function loadRFQDetails(reqDataUrl, authToken, dataStr) {
    return new Promise((resolve, error) => {
        $.ajax({
            url: reqDataUrl,
            type: 'Post',
            dataType: 'json',
            data: JSON.stringify(dataStr),
            headers: {
                "Content-Type": 'application/json; charset=utf-8',
                "Authorization": "Bearer " + authToken,
            },
            success: function (data, status, xhr) {
                $("#txtRFQNo").append("<span>Are you confim to Cancel </span><span>"+data.RFQNo+"?</span>");
                resolve(data);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                error(xhr);
            }
        })
    })
}

function showDeleteDrawer(ID) {
    var targetDrawer = $("#DeleteDraftModal");
    //Drawer_Hide($("#CancelRFQModal"))
    Drawer_Show(targetDrawer, false);
    setCurrentSelectedDraft(ID);
}
    

$.contextMenu({
    selector: '#tblRFQData tbody tr',
    className: 'css-title-toolbox',
    items: {
        'delete': {
            name: 'Delete',
            icon: 'fa-trash-can',
            callback: function (key, options) {
               var targetDrawer = $("#CancelRFQModal");
               var rowData = t.row(options.$trigger).data();
               $("#txtRFQNo span").text("");

                var dataStr = {
                    ID: rowData.ID
                }
                setCurrentSelectedRFQ(rowData.ID);
                //$(`#${hiddenTabID_ID}`).val(rowData.ModuleID);

                Drawer_ResetInput(targetDrawer);
                Drawer_Show(targetDrawer, true);

                loadRFQDetails(reqDataUrl, authToken, dataStr)
                    .then(() => {
                        Drawer_Show(targetDrawer, false);
                        
                    })
                    .catch((error) => {
                        Drawer_Hide(targetDrawer);
                        ShowError('Failt To Load Tab Details', error.responseText || error)
                    })
            }
        },
        'details': {
            name: 'RFQ Details',
            icon: 'fa-trash-can',
            callback: function (key, options) {
                var rowData = t.row(options.$trigger).data();
                toUrl = "/Views/PurchasingRFQManagement/RFQDetails/" + rowData.ID
                location.href = toUrl;
            }
        }
    }
})

function changeToPurchasingList() {
    $("#btnLogistic").removeClass("highlightText");
    $("#btnPurchasing").addClass("highlightText");
}

function changeToLogisticList() {
    $("#btnLogistic").addClass("highlightText");
    $("#btnPurchasing").removeClass("highlightText");
}